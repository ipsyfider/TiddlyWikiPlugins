/***
|''Name:''|TiddlersBarPlugin|
|''Description:''|Provides browser-like tabs to switch between tiddlers.|
|''Author:''|Pascal Collin / fork: [[Tobias Beer|http://tobibeer.github.io]]|
|''Version:''|1.3.7 (2013-10-06)|
|''~CoreVersion:''|2.5.2|
|''Source:''|https://raw.github.com/tobibeer/TiddlyWikiPlugins/master/forked/PascalCollin/TiddlersBarPlugin.min.js|
|''License:''|[[BSD Open Source License|http://visualtw.ouvaton.org/VisualTW.html#License]]|
!Options
<<option chkDisableTabsBar>> ''chkDisableTabsBar'' &nbsp; <<option chkHideTabsBarWhenSingleTab>> ''chkHideTabsBarWhenSingleTab''
;txtSelectedTiddlerTabButton
:<<option txtSelectedTiddlerTabButton>> (selected tab command)
;txtPreviousTabKey
:<<option txtPreviousTabKey>> (access key)
;txtNextTabKey
:<<option txtNextTabKey>> (access key)
***/
// /%
(function(e){var t=config.options;e.each({chkDisableTabsBar:false,chkHideTabsBarWhenSingleTab:false,txtSelectedTiddlerTabButton:"closeOthers",txtPreviousTabKey:"",txtNextTabKey:""},function(e,n){if(t[e]==undefined)t[e]=n});var n=config.macros.tiddlersBar={tooltip:"Show %0...",tooltipClose:"Close tiddler...",tooltipSave:"Save tiddler...",promptRename:"Enter new tiddler name",previousState:false,previousKey:t.txtPreviousTabKey,nextKey:t.txtNextTabKey,tabsAnimationSource:null,handler:function(e,t,r){var i,s,o,u,a=null;if(n.isShown()){story.forEachTiddler(function(t,r){if(t==n.currentTab){o=createTiddlyElement(null,"span",null,"tab tabSelected");n.createActiveTabButton(o,t);if(a&&n.previousKey)a.setAttribute("accessKey",n.nextKey);a="active"}else{o=createTiddlyElement(e,"span",null,"tab tabUnselected");i=createTiddlyButton(o,t,n.tooltip.format([t]),n.onSelectTab);i.setAttribute("tiddler",t);if(a=="active"&&n.nextKey)i.setAttribute("accessKey",n.previousKey);a=i}u=story.isDirty(t);s=createTiddlyButton(o,u?"!":"x",u?n.tooltipSave:n.tooltipClose,u?n.onTabSave:n.onTabClose,"tabButton");s.setAttribute("tiddler",t);if(e.childNodes){e.insertBefore(document.createTextNode(" "),e.firstChild);e.insertBefore(o,e.firstChild)}else e.appendChild(o)});n.paint()}},refresh:function(e,t){removeChildren(e);n.handler(e,"tiddlersBar",t);if(n.previousState!=n.isShown()){story.refreshAllTiddlers();if(n.previousState)story.forEachTiddler(function(e,t){t.style.display=""});n.previousState=!n.previousState}},isShown:function(){if(t.chkDisableTabsBar)return false;if(!t.chkHideTabsBarWhenSingleTab)return true;var e=0;story.forEachTiddler(function(){e++});return e>1},selectNextTab:function(e){var t="";story.forEachTiddler(function(e){if(!n.currentTab){story.displayTiddler(null,e);return}if(e==n.currentTab){if(t){story.displayTiddler(null,t);return}else n.currentTab=""}else t=e})},onSelectTab:function(e){var t=this.getAttribute("tiddler");if(t)story.displayTiddler(null,t);return false},onTabClose:function(e){var t=this.getAttribute("tiddler");if(t){if(story.hasChanges(t)&&!readOnly){if(!confirm(config.commands.cancelTiddler.warning.format([t])))return false}story.closeTiddler(t)}return false},onTabSave:function(e){var t=this.getAttribute("tiddler");e=e||window.event;if(t)config.commands.saveTiddler.handler(e,null,t);return false},onSelectedTabButtonClick:function(e,n,r){var i=this.getAttribute("tiddler");e=e||window.event;if(i&&t.txtSelectedTiddlerTabButton&&config.commands[t.txtSelectedTiddlerTabButton])config.commands[t.txtSelectedTiddlerTabButton].handler(e,n,i);return false},onTiddlersBarAction:function(e){var t=e.target?e.target.id:e.srcElement.id;if(t=="tiddlersBar")story.displayTiddler(null,"New Tiddler",DEFAULT_EDIT_TEMPLATE,false,null,null)},createActiveTabButton:function(r,i){if(t.txtSelectedTiddlerTabButton&&config.commands[t.txtSelectedTiddlerTabButton]){var s=createTiddlyButton(r,i,config.commands[t.txtSelectedTiddlerTabButton].tooltip,n.onSelectedTabButtonClick);s.setAttribute("tiddler",i)}else{createTiddlyText(r,i);e("place").attr("title","")}},paint:function(){paint=config.macros.paint;if(paint)e("#tiddlersBar .tab").each(function(){paint.setStyle(e(this),e("[tiddler]",this).attr("tiddler"),"tab")})}};Story.prototype.closeTiddlerTIDDLERSBAR=Story.prototype.closeTiddler;Story.prototype.closeTiddler=function(e,t,r){t=false;story.closeTiddlerTIDDLERSBAR.apply(this,arguments);n.currentTab="";n.selectNextTab();var i=document.getElementById("tiddlersBar");if(i)n.refresh(i,null)};Story.prototype.displayTiddlerTIDDLERSBAR=Story.prototype.displayTiddler;Story.prototype.displayTiddler=function(e,t,r,i,s,o,u){e=null;var a=document.getElementById("tiddlersBar");var f=story.displayTiddlerTIDDLERSBAR.apply(this,arguments);var l=f?f.getAttribute("tiddler"):t instanceof Tiddler?t.title:t;if(n.isShown()){story.forEachTiddler(function(e,t){if(e!=l)t.style.display="none";else t.style.display=""});n.currentTab=l}if(a)n.refresh(a,null);window.scrollTo(0,0);return f};config.shadowTiddlers.StyleSheetTiddlersBar=["/*{{{*/","#tiddlersBar {padding : 1em 0.5em 0 0.5em;}","#tiddlersBar .button {border:0;}","#tiddlersBar .tab {border:0; border-top:2px [[ColorPalette::TertiaryPale]];border-bottom:2px solid [[ColorPalette::TertiaryPale]];white-space:nowrap; padding:2px 5px;}","#tiddlersBar .tabSelected {background:transparent;border-top-color:transparent;}","#tiddlersBar .tabUnselected {background:[[ColorPalette::TertiaryPale]]}","#tiddlersBar a {color:[[ColorPalette::TertiaryDark]]}","#tiddlersBar .button:hover,","#tiddlersBar .tabButton:hover{background:transparent;color:[[ColorPalette::PrimaryDark]];}",".tabUnselected .tabButton,",".tabSelected .tabButton {padding : 0 2px 0 2px; margin: 0 0 0 4px; color: [[ColorPalette::TertiaryMid]];}",".tiddler, .tabContents {border:none;}","/*}}}*/"].join("\n");store.addNotification("StyleSheetTiddlersBar",refreshStyles);config.shadowTiddlers.PageTemplate=config.shadowTiddlers.PageTemplate.replace(/<div id='tiddlerDisplay'><\/div>/m,["<div id='tiddlersBar'"," refresh='none'"," ondblclick='config.macros.tiddlersBar.onTiddlersBarAction(event)'>","</div>\n","<div id='tiddlerDisplay'></div>"].join(""));refreshPageTemplateTIDDLERSBAR=refreshPageTemplate;refreshPageTemplate=function(e){refreshPageTemplateTIDDLERSBAR(e);if(n)n.refresh(document.getElementById("tiddlersBar"))};config.refreshers.none=function(){return true}})(jQuery)
// %/